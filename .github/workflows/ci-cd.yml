# =============================================================================
# GitHub Actions CI/CD Pipeline for QA Portfolio
# =============================================================================
# This workflow:
#   1. Builds and tests all three projects
#   2. Optionally deploys to Azure Container Apps (on main branch)
#
# Required GitHub Secrets for deployment:
#   - AZURE_CREDENTIALS: Service principal JSON for Azure login
#   - AZURE_REGISTRY_NAME: Azure Container Registry name (e.g., "myregistry")
#   - AZURE_RESOURCE_GROUP: Azure resource group name
#   - AZURE_CONTAINERAPP_NAME: Azure Container App name
#   - DB_PASSWORD: PostgreSQL database password
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # ===========================================================================
  # BUILD & TEST JOB
  # ===========================================================================
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Run unit tests
      run: dotnet test --configuration Release --no-build --verbosity normal --logger trx --results-directory "TestResults"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: TestResults
        retention-days: 30

  # ===========================================================================
  # BUILD WEB APP JOB
  # ===========================================================================
  build-webapp:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Publish Web App
      run: dotnet publish -c Release -o ./publish

    - name: Upload published app
      uses: actions/upload-artifact@v4
      with:
        name: webapp-publish
        path: TestableWebApp/publish
        retention-days: 7

  # ===========================================================================
  # DEPLOY TO AZURE CONTAINER APPS (only on main branch)
  # ===========================================================================
  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: build-webapp
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    # Only run if secrets are configured
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: az acr login --name ${{ secrets.AZURE_REGISTRY_NAME }}

    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/testablewebapp:${{ github.sha }} .
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/testablewebapp:${{ github.sha }}

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ secrets.AZURE_CONTAINERAPP_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --image ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/testablewebapp:${{ github.sha }}

    - name: Get Service URL
      run: |
        URL=$(az containerapp show --name ${{ secrets.AZURE_CONTAINERAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
        echo "Deployed to: https://$URL"
        echo "Swagger: https://$URL/swagger"
